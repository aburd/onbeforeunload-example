<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>git </title>
    <style>
        body {
            background: papayawhip;
        }

        .container {
            width: 1200px;
            margin: auto;
        }

        .time {
            display: inline-block;
        }

        .data {
            display: inline-block;
            text-align: left;
            width: 40px;
        }

        .seconds {
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>onbeforeunloadの例</h1>
        <p>このwindowを閉じたら、nodeのサーバーにいる時間を記録する</p>
        <p>
            <input type="checkbox" name="alert" id="alert" checked>
            <label for="alert">アラートwindowを出す</label>
        </p>
        <div>
            ページにいる時間:
            <div class="time">
                <span class="data"></span>
                <div class="seconds">秒</div>
            </div>
        </div>
    </div>
</body>

<script>
    function getTimeOnPage(startTime, endTime) {
        var actual = (endTime - startTime) / 1000;
        var rounded = Math.round(actual * 100) / 100;
        var timeStr = String(rounded).length < 4 ? String(rounded) + '0' : String(rounded)
        return {
            actual: actual,
            rounded: rounded,
            timeStr: timeStr,
        };
    }
    function main() {
        var url = 'http://localhost:3000';
        var startTime = Date.now();

        window.onbeforeunload = function (e) {
            var data = { timeStats: getTimeOnPage(startTime, Date.now()) }
            var oReq = new XMLHttpRequest();
            oReq.open("POST", url);
            oReq.setRequestHeader("Content-type", "application/json");
            oReq.send(JSON.stringify(data));

            var alertChk = document.querySelector('#alert');
            if (alertChk.checked) {
                var dialogText = 'Dialog text here';
                e.returnValue = dialogText;
                return dialogText;
            }
        }

        var dataTag = document.querySelector('.data');
        function updateTime() {
            var timeStats = getTimeOnPage(startTime, Date.now());
            dataTag.innerHTML = timeStats.timeStr;
            requestAnimationFrame(updateTime);
        }
        requestAnimationFrame(updateTime)
    }
    window.onload = main;
</script>

</html>